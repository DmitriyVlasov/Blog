<!DOCTYPE html>
<html lang="ru-ru">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.7.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Дмитрий Власов">

  
  
  
    
  
  <meta name="description" content="Now that we have discussed the basics of FParsec we are well prepared to work through a real world parser example: a JSON parser.
JSON (JavaScript Object Notation) is a text-based data interchange format with a simple and lightweight syntax. You can find descriptions of the syntax on json.org and in RFC 4626.
In many applications one only has to deal with JSON files describing one particular kind of object. In such a context it sometimes can be appropriate to write a specialized parser just for that specific kind of JSON file.">

  
  <link rel="alternate" hreflang="ru-ru" href="https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/">

  


  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/monokai-sublime.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/monokai-sublime.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-91250239-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           document.location = url;
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target);  
  }

  gtag('js', new Date());
  gtag('config', 'UA-91250239-1', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  

  <link rel="manifest" href="/ru/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hucbbc31a72d99417bde92f4ec84ba243f_10104_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hucbbc31a72d99417bde92f4ec84ba243f_10104_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Дмитрий Власов">
  <meta property="og:url" content="https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/">
  <meta property="og:title" content="Глава 11. Синтаксический анализ JSON | Дмитрий Власов">
  <meta property="og:description" content="Now that we have discussed the basics of FParsec we are well prepared to work through a real world parser example: a JSON parser.
JSON (JavaScript Object Notation) is a text-based data interchange format with a simple and lightweight syntax. You can find descriptions of the syntax on json.org and in RFC 4626.
In many applications one only has to deal with JSON files describing one particular kind of object. In such a context it sometimes can be appropriate to write a specialized parser just for that specific kind of JSON file."><meta property="og:image" content="https://DmitriyVlasov.ru/images/icon_hucbbc31a72d99417bde92f4ec84ba243f_10104_512x512_fill_lanczos_center_2.png">
  <meta property="twitter:image" content="https://DmitriyVlasov.ru/images/icon_hucbbc31a72d99417bde92f4ec84ba243f_10104_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="ru-ru">
  
    
      <meta property="article:published_time" content="2017-01-28T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2017-01-28T00:00:00&#43;00:00">
  

  


    











<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/"
  },
  "headline": "Глава 11. Синтаксический анализ JSON",
  
  "datePublished": "2017-01-28T00:00:00Z",
  "dateModified": "2017-01-28T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Дмитрий Власов"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Авара АйТи",
    "logo": {
      "@type": "ImageObject",
      "url": "img/https://DmitriyVlasov.ru/"
    }
  },
  "description": "Now that we have discussed the basics of FParsec we are well prepared to work through a real world parser example: a JSON parser.\nJSON (JavaScript Object Notation) is a text-based data interchange format with a simple and lightweight syntax. You can find descriptions of the syntax on json.org and in RFC 4626.\nIn many applications one only has to deal with JSON files describing one particular kind of object. In such a context it sometimes can be appropriate to write a specialized parser just for that specific kind of JSON file."
}
</script>

  

  


  


  





  <title>Глава 11. Синтаксический анализ JSON | Дмитрий Власов</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Поиск</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Поиск ..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  

<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/ru/">Дмитрий Власов</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Переключить навигацию">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/ru/">Дмитрий Власов</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/ru/#about"><span>Обо мне</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/ru/#posts"><span>Блог</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/ru/#talks"><span>Выступления</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/ru/#featured"><span>Публикации</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/ru/domain/"><span>Интересы</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/ru/#contact"><span>Контакты</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      <li class="nav-item">
        <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
      </li>
      

      

    </ul>

  </div>
</nav>


  <div class="pub">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Глава 11. Синтаксический анализ JSON</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    01.2017
  </span>
  

  

  

  
  
  

  
  

</div>

    













<div class="btn-links mb-3">
  
  








  
















  
  
    
  
<a class="btn btn-outline-primary my-1 mr-1" href="http://www.quanttec.com/fparsec/tutorial.html#parsing-json" target="_blank" rel="noopener">
  Исходный документ
</a>




</div>


  
</div>



  <div class="article-container">

    

    
    <div class="row">
      <div class="col-md-1"></div>
      <div class="col-md-10">
        <div class="row">
          <div class="col-12 col-md-3 pub-row-heading">Тип публикации</div>
          <div class="col-12 col-md-9">
            
            
            <a href="/ru/publication/#6">
              Глава книги
            </a>
            
          </div>
        </div>
      </div>
      <div class="col-md-1"></div>
    </div>
    <div class="d-md-none space-below"></div>
    

    
    <div class="row">
      <div class="col-md-1"></div>
      <div class="col-md-10">
        <div class="row">
          <div class="col-12 col-md-3 pub-row-heading">Публикация</div>
          <div class="col-12 col-md-9">Учебник библиотеки FParsec</div>
        </div>
      </div>
      <div class="col-md-1"></div>
    </div>
    <div class="d-md-none space-below"></div>
    

    <div class="space-below"></div>

    <div class="article-style"><p>Now that we have discussed the basics of FParsec we are well prepared to work through a real world parser example: a JSON parser.</p>
<p>JSON (JavaScript Object Notation) is a text-based data interchange format with a simple and lightweight syntax. You can find descriptions of the syntax on <a href="http://json.org">json.org</a> and in <a href="http://www.ietf.org/rfc/rfc4627.txt">RFC 4626</a>.</p>
<p>In many applications one only has to deal with JSON files describing one particular kind of object. In such a context it sometimes can be appropriate to write a specialized parser just for that specific kind of JSON file. In this tutorial, however, we will follow a more general approach. We will implement a parser that can parse any general JSON file into an AST, i.e. an intermediate data structure describing the contents of the file. Applications can then conveniently query this data structure and extract the information they need. This is an approach comparable to that of XML parsers which build a data structure describing the document tree of an XML document. The great advantage of this approach is that the JSON parser itself becomes reusable and the document specific parsing logic can be expressed in the form of simple functions processing the AST of the JSON document.</p>
<p>The natural way to implement an AST in F# is with the help of a discriminated union type. If you look at the <a href="http://json.org">JSON specification</a>, you can see that a JSON value can be a string, a number, a boolean, null, a comma-separated list of values in square brackets, or an object with a sequence of key-value pairs in curly brackets.</p>
<p>In our parser we will use the following union type to represent JSON values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Json</span> <span style="color:#f92672">=</span> JString <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span>
          <span style="color:#f92672">|</span> JNumber <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">float</span>
          <span style="color:#f92672">|</span> JBool   <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">bool</span>
          <span style="color:#f92672">|</span> JNull
          <span style="color:#f92672">|</span> JList   <span style="color:#66d9ef">of</span> Json <span style="color:#66d9ef">list</span>
          <span style="color:#f92672">|</span> JObject <span style="color:#66d9ef">of</span> Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">,</span> Json<span style="color:#f92672">&gt;</span>
</code></pre></div><p>Here we&rsquo;ve chosen the F# <code>list</code> type to represent a sequence of values and the <code>Map</code> type to represent a sequence of key-value pairs, because these types are particularly convenient to process in F#.[fn If you need to parse huge sequences and objects, it might be more appropriate to use an array and dictionary for JList and JObject respectively.] Note that the <code>Json</code> type is recursive, since both <code>JList</code> and <code>JObject</code> values can themselves contain <code>Json</code> values. Our parser will have to reflect this recursive structure.</p>
<hr>
<p>###Tip
If you&rsquo;re new to FParsec and have a little time, it would be a good exercise to try to implement the JSON parser on your own (with the help of the reference documentation). This tutorial already covered almost everything you need and the JSON grammar is simple enough that this shouldn&rsquo;t take too much time. Of course, you can always peek at the implementation below if you get stuck.</p>
<hr>
<p>We start the actual parser implementation by covering the simple <code>null</code> and boolean cases:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> jnull <span style="color:#f92672">=</span> stringReturn <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">null</span><span style="color:#e6db74">&#34;</span> JNull
<span style="color:#66d9ef">let</span> jool <span style="color:#f92672">=</span>      <span style="color:#f92672">(</span>stringReturn <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">true</span><span style="color:#e6db74">&#34;</span>  <span style="color:#f92672">(</span>JBool <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">&lt;</span><span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">(</span>stringReturn <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">false</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">(</span>JBool <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
</code></pre></div><p>Handling the number case is just as simple, because the JSON number format is based on the typical floating-point number format used in many programming languages and hence can be parsed with FParsec&rsquo;s built-in <code>pfloat</code> parser:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> jnumber <span style="color:#f92672">=</span> pfloat <span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> JNumber
</code></pre></div><p>(Note that F# allows us to pass the object constructor <code>JNumber</code> as a function argument.)</p>
<p>If you compare the precise number format supported by <code>pfloat</code> with that in the JSON spec, you&rsquo;ll see that <code>pfloat</code> supports a superset of the JSON format. In contrast to the JSON format the <code>pfloat</code> parser also recognizes <code>NaN</code> and <code>Infinity</code> values, accepts a leading plus sign, accepts leading zeros and even supports the hexadecimal float format of Java and C99. Depending on the context this behaviour can be considered a feature or a limitation of the parser. For most applications it probably doesn&rsquo;t matter, and the JSON RFC clearly states that a JSON parser may support a superset of the JSON syntax. However, if you&rsquo;d rather only support the exact JSON number format, you can implement such a float parser rather easily based on the configurable <code>numberLiteral</code> parser (just have a look at how this is currently done in the <code>pfloat</code> source).</p>
<p>The JSON string format takes a little more effort to implement, but we&rsquo;ve already parsed a similar format with the <code>stringLiteral</code> parsers in [Parsing string data](#Parsing string data), so we can just adapt one of those parsers for our purpose:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> stringLiteral <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">let</span> escape <span style="color:#f92672">=</span>  anyOf <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/bfnrt</span><span style="color:#e6db74">&#34;</span>
                  <span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">function</span>
                      <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;b&#39;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>
                      <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;f&#39;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u000C</span><span style="color:#e6db74">&#34;</span>
                      <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;n&#39;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
                      <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;r&#39;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>
                      <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;t&#39;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>
                      <span style="color:#f92672">|</span> c   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">string</span> c <span style="color:#75715e">// every other char is mapped to itself
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">let</span> unicodeEscape <span style="color:#f92672">=</span>
    	<span style="color:#e6db74">/// converts a hex char ([0-9a-fA-F]) to its integer number (0-15)
</span><span style="color:#e6db74"></span>        <span style="color:#66d9ef">let</span> hex2int c <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>int c <span style="color:#f92672">&amp;&amp;</span><span style="color:#f92672">&amp;</span> 15<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>int c <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> 6<span style="color:#f92672">)</span><span style="color:#f92672">*</span>9

        str <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> pipe4 hex hex hex hex <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> h3 h2 h1 h0 <span style="color:#f92672">-&gt;</span>
            <span style="color:#f92672">(</span>hex2int h3<span style="color:#f92672">)</span><span style="color:#f92672">*</span>4096 <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>hex2int h2<span style="color:#f92672">)</span><span style="color:#f92672">*</span>256 <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>hex2int h1<span style="color:#f92672">)</span><span style="color:#f92672">*</span>16 <span style="color:#f92672">+</span> hex2int h0
            <span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">string</span>
        <span style="color:#f92672">)</span>

    <span style="color:#66d9ef">let</span> escapedCharSnippet <span style="color:#f92672">=</span> str <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> <span style="color:#f92672">(</span>escape <span style="color:#f92672">&lt;</span><span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span> unicodeEscape<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">let</span> normalCharSnippet  <span style="color:#f92672">=</span> manySatisfy <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> c <span style="color:#f92672">-&gt;</span> c <span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#39;\\&#39;</span><span style="color:#f92672">)</span>

    between <span style="color:#f92672">(</span>str <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>str <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">(</span>stringsSepBy normalCharSnippet escapedCharSnippet<span style="color:#f92672">)</span>
</code></pre></div><p><code>stringLiteral</code> parses string literals as a sequence of normal char snippets separated by escaped char snippets. A normal char snippet is any sequence of chars that does not contain the chars <code>'&quot;'</code> and <code>'\\'</code>. An escaped char snippet consists of a backslash followed by any of the chars <code>'\\'</code>, <code>'\&quot;'</code>, <code>'/'</code>, <code>'b'</code>, <code>'f'</code>, <code>'n'</code>, <code>'r'</code>, <code>'t'</code>, or an Unicode escape. An Unicode escape consists of an <code>'u'</code> followed by four hex chars representing an UTF-16 code point.</p>
<p>[#createParserForwardedToRef-example]
The grammar rules for JSON lists and objects are recursive, because any list or object can contain itself any kind of JSON value. Hence, in order to write parsers for the list and object grammar rules, we need a way to refer to the parser for any kind of JSON value, even though we haven&rsquo;t yet constructed this parser. Like it is so often in computing, we can solve this problem by introducing an extra indirection:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> jvalue<span style="color:#f92672">,</span> jvalueRef <span style="color:#f92672">=</span> createParserForwardedToRef<span style="color:#f92672">&lt;</span>Json<span style="color:#f92672">,</span> <span style="color:#66d9ef">unit</span><span style="color:#f92672">&gt;</span>()
</code></pre></div><p>As you might have guessed from the name, <code>createParserForwardedToRef</code> creates a parser (<code>jvalue</code>) that forwards all invocations to the parser in a reference cell (<code>jvalueRef</code>). Initially, the reference cell holds a dummy parser, but since the reference cell is mutable, we can later replace the dummy parser with the actual value parser, once we have finished constructing it.</p>
<p>The JSON RFC sensibly only permits spaces, (horizontal) tabs, line feeds and carriage returns as whitespace characters, which allows us to use the built-in <code>spaces</code> parser for parsing whitespace:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> ws <span style="color:#f92672">=</span> spaces
</code></pre></div><p>Both JSON lists and objects are syntactically represented as a comma-separated lists of &ldquo;elements&rdquo; between brackets, where whitespace is allowed before and after any bracket, comma and list element. We can conveniently parse such lists with the following helper function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> listBetweenStrings sOpen sClose pElement f <span style="color:#f92672">=</span>
    between <span style="color:#f92672">(</span>str sOpen<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>str sClose<span style="color:#f92672">)</span>
            <span style="color:#f92672">(</span>ws <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> sepBy <span style="color:#f92672">(</span>pElement <span style="color:#f92672">.</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> ws<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>str <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">,</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> ws<span style="color:#f92672">)</span> <span style="color:#f92672">|</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> f<span style="color:#f92672">)</span>
</code></pre></div><p>This function takes four arguments: an opening string, a closing string, an element parser and a function that is applied to the parsed list of elements.</p>
<p>With the help of this function we can define the parser for a JSON list as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> jlist   <span style="color:#f92672">=</span> listBetweenStrings <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">[</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">]</span><span style="color:#e6db74">&#34;</span> jvalue JList
</code></pre></div><p>JSON objects are lists of key-value pairs, so we need a parser for a key-value pair:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> keyValue <span style="color:#f92672">=</span> stringLiteral <span style="color:#f92672">.</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> str <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">:</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> ws <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> jvalue<span style="color:#f92672">)</span>
</code></pre></div><p>(Remember, the points on both sides of <code>.&gt;&gt;.</code> indicate that the results of the two parsers on both sides are returned as a tuple.)</p>
<p>By passing the <code>keyValue</code> parser to <code>listBetweenStrings</code> we obtain a parser for JSON objects:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> jobject <span style="color:#f92672">=</span> listBetweenStrings <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> keyValue <span style="color:#f92672">(</span>Map.ofList <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> JObject<span style="color:#f92672">)</span>
</code></pre></div><p>[#json-value-parser]
Having defined parsers for all the possible kind of JSON values, we can combine the different cases with a <code>choice</code> parser to obtain the finished parser for JSON values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">do</span> jvalueRef <span style="color:#f92672">:=</span> choice <span style="color:#f92672">[</span>jobject
                        jlist
                        jstring
                        jnumber
                        jtrue
                        jfalse
                        jnull<span style="color:#f92672">]</span>
</code></pre></div><p>The <code>jvalue</code> parser doesn&rsquo;t accept leading or trailing whitespace, so we need to define our parser for complete JSON documents as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> json <span style="color:#f92672">=</span> ws <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span> jvalue <span style="color:#f92672">.</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> ws <span style="color:#f92672">.</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> eof
</code></pre></div><p>This parser will try to consume a complete JSON input stream and, if successful, will return a <code>Json</code> AST of the input as the parser result</p>
<p>And that&rsquo;s it, we&rsquo;re finished with our JSON parser. If you want to try this parser out on some sample input, please take a look at the JSON project in the <strong>Samples</strong> folder.</p>
</div>

    







<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/&amp;text=%d0%93%d0%bb%d0%b0%d0%b2%d0%b0%2011.%20%d0%a1%d0%b8%d0%bd%d1%82%d0%b0%d0%ba%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9%20%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7%20JSON" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/&amp;t=%d0%93%d0%bb%d0%b0%d0%b2%d0%b0%2011.%20%d0%a1%d0%b8%d0%bd%d1%82%d0%b0%d0%ba%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9%20%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7%20JSON" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=%d0%93%d0%bb%d0%b0%d0%b2%d0%b0%2011.%20%d0%a1%d0%b8%d0%bd%d1%82%d0%b0%d0%ba%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9%20%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7%20JSON&amp;body=https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/&amp;title=%d0%93%d0%bb%d0%b0%d0%b2%d0%b0%2011.%20%d0%a1%d0%b8%d0%bd%d1%82%d0%b0%d0%ba%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9%20%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7%20JSON" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=%d0%93%d0%bb%d0%b0%d0%b2%d0%b0%2011.%20%d0%a1%d0%b8%d0%bd%d1%82%d0%b0%d0%ba%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9%20%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7%20JSON%20https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://DmitriyVlasov.ru/ru/publication/fparsec-tutorial/11-parsing-json/&amp;title=%d0%93%d0%bb%d0%b0%d0%b2%d0%b0%2011.%20%d0%a1%d0%b8%d0%bd%d1%82%d0%b0%d0%ba%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9%20%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7%20JSON" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  






  
  
  
    
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="portrait mr-3" src="/ru/authors/me/avatar_hu0f3384a45cfed84d836ae65623f6317a_1784134_250x250_fill_q90_lanczos_center.jpg" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://DmitriyVlasov.ru/">Дмитрий Власов</a></h5>
      <h6 class="card-subtitle">Старший BI разработчик</h6>
      <p class="card-text">Бизнес аналитика, функциональное программирование и машинное обучение.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/ru/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/DmitriyVlasov" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://vk.com/DmitriyVlasovRu" target="_blank" rel="noopener">
        <i class="fab fa-vk"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://facebook.com/MeDmitriyVlasovRu" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/DmitriyVlasovRu" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://linkedin.com/in/DmitriyVlasov" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>







<div class="article-widget">
  
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Следующий</div>
    <a href="/ru/publication/fparsec-tutorial/10-fsharps-value-restriction/" rel="next">Глава 10. Ограничение значений F#</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Предыдущий</div>
    <a href="/ru/publication/fparsec-tutorial/12-what-now/" rel="prev">Глава 12. Куда дальше?</a>
  </div>
  
</div>

</div>



  
  



  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.3/mermaid.min.js" integrity="" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js" integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/fsharp.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/ru/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"результат не найден","placeholder":"Поиск ...","results":"результат найден"};
      const content_type = {
        'post': "Статьи",
        'project': "Проекты",
        'publication' : "Публикации",
        'talk' : "Выступления"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.a0d331bcd05dbe8b31e244f796710f08.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    © <a href="https://ru.wikipedia.org/wiki/%D0%92%D0%B8%D0%BA%D0%B8%D0%BF%D0%B5%D0%B4%D0%B8%D1%8F:%D0%A2%D0%B5%D0%BA%D1%81%D1%82_%D0%BB%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D0%B8_Creative_Commons_Attribution-ShareAlike_3.0_Unported">Creative Commons Attribution-ShareAlike 3.0 Unported</a> &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Процитировать</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Копия
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Скачать
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
